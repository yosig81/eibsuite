# Makefile.integration -- Integration tests for EIBServer + Emulator-ng
#
# Builds a single test binary that links the real server and emulator code
# (no stubs).  The emulator runs in-process on loopback, providing a
# real EIBNet/IP device for the server to tunnel to.
#
# Usage:
#   make -f Makefile.integration          # build
#   make -f Makefile.integration run      # build + run
#   make -f Makefile.integration clean    # remove artifacts

-include ../../Makefile.rules

# Compiler and flags
CPP_COMPILER ?= g++

# Platform detection (used for gtest lib path and rpath)
UNAME_S := $(shell uname -s)

# Google Test: try Homebrew first, then user-built location
GTEST_BREW := $(shell brew --prefix googletest 2>/dev/null)
ifdef GTEST_BREW
  GTEST_INCLUDE ?= $(GTEST_BREW)/include
  GTEST_LIB_DIR ?= $(GTEST_BREW)/lib
else
  GTEST_ROOT ?= $(HOME)/Projects/googletest-v1.17.0
  GTEST_INCLUDE ?= $(GTEST_ROOT)/googletest/include
  ifeq ($(UNAME_S),Darwin)
    GTEST_LIB_DIR ?= $(GTEST_ROOT)/manual-arm64
  else
    GTEST_LIB_DIR ?= $(GTEST_ROOT)/build/lib
  endif
endif

CPPFLAGS := -I../include -I../include/conf \
            -I../../EIBStdLib/include -I../../EIBStdLib/include/xml \
            -I../../Emulator-ng/include \
            -I../../jtc/include \
            -Ifixtures \
            -I$(GTEST_INCLUDE)
CXXFLAGS := -O0 -g3 -Wall -fmessage-length=0 -std=c++17 -Wno-dynamic-exception-spec

# Platform-specific rpath: @loader_path on macOS, $ORIGIN on Linux
ifeq ($(UNAME_S),Darwin)
  RPATH_ORIGIN := @loader_path
else
  RPATH_ORIGIN := $$ORIGIN
endif

LDFLAGS := -L../../EIBStdLib/linux -L../../jtc/linux -L$(GTEST_LIB_DIR) \
           -Wl,-rpath,'$(RPATH_ORIGIN)/../../EIBStdLib/linux' \
           -Wl,-rpath,'$(RPATH_ORIGIN)/../../jtc/linux' \
           -Wl,-rpath,'$(GTEST_LIB_DIR)'
LIBS := -lEIBStdLib -ljtc -lgtest -lpthread

# ---------------------------------------------------------------------------
# Source files
# ---------------------------------------------------------------------------

# Server sources (all except Main.cpp -- we link the real implementations)
SERVER_SRCS := ../src/BusMonConnection.cpp \
               ../src/Client.cpp \
               ../src/ClientsMgr.cpp \
               ../src/CommandScheduler.cpp \
               ../src/Dispatcher.cpp \
               ../src/EIBHandler.cpp \
               ../src/EIBInterface.cpp \
               ../src/EIBServer.cpp \
               ../src/PacketFilter.cpp \
               ../src/RoutingConnection.cpp \
               ../src/ServerConfig.cpp \
               ../src/TunnelConnection.cpp \
               ../src/UsersDB.cpp \
               ../src/WebHandler.cpp \
               ../src/XmlJsonUtil.cpp \
               ../src/conf/EIBBusMonConf.cpp \
               ../src/conf/EIBInterfaceConf.cpp \
               ../src/conf/EIBServerUsersConf.cpp

# Emulator sources (core only -- no Main.cpp, no EmulatorCmd.cpp)
EMULATOR_SRCS := ../../Emulator-ng/src/Emulator-ng.cpp \
                 ../../Emulator-ng/src/EmulatorHandler.cpp \
                 ../../Emulator-ng/src/EmulatorConfig.cpp \
                 ../../Emulator-ng/src/EmulatorDB.cpp

# Fixture sources
FIXTURE_SRCS := fixtures/EmulatorWrapper.cpp

# ---------------------------------------------------------------------------
# Directories
# ---------------------------------------------------------------------------
INTEG_DIR := integration
BUILD_DIR := build_integ
TEST_EXECUTABLE := run_integration_tests

# ---------------------------------------------------------------------------
# Object file lists
# ---------------------------------------------------------------------------
TEST_SOURCES := $(wildcard $(INTEG_DIR)/*.cpp)
TEST_OBJECTS := $(TEST_SOURCES:$(INTEG_DIR)/%.cpp=$(BUILD_DIR)/%.o)

FIXTURE_OBJECTS := $(BUILD_DIR)/EmulatorWrapper.o

# Server objects -- flatten into BUILD_DIR
SERVER_OBJECTS := $(BUILD_DIR)/BusMonConnection.o \
                  $(BUILD_DIR)/Client.o \
                  $(BUILD_DIR)/ClientsMgr.o \
                  $(BUILD_DIR)/CommandScheduler.o \
                  $(BUILD_DIR)/Dispatcher.o \
                  $(BUILD_DIR)/EIBHandler.o \
                  $(BUILD_DIR)/EIBInterface.o \
                  $(BUILD_DIR)/EIBServer.o \
                  $(BUILD_DIR)/PacketFilter.o \
                  $(BUILD_DIR)/RoutingConnection.o \
                  $(BUILD_DIR)/ServerConfig.o \
                  $(BUILD_DIR)/TunnelConnection.o \
                  $(BUILD_DIR)/UsersDB.o \
                  $(BUILD_DIR)/WebHandler.o \
                  $(BUILD_DIR)/XmlJsonUtil.o \
                  $(BUILD_DIR)/EIBBusMonConf.o \
                  $(BUILD_DIR)/EIBInterfaceConf.o \
                  $(BUILD_DIR)/EIBServerUsersConf.o

EMULATOR_OBJECTS := $(BUILD_DIR)/Emulator-ng.o \
                    $(BUILD_DIR)/EmulatorHandler.o \
                    $(BUILD_DIR)/EmulatorConfig.o \
                    $(BUILD_DIR)/EmulatorDB.o

ALL_OBJECTS := $(TEST_OBJECTS) $(SERVER_OBJECTS) $(EMULATOR_OBJECTS) $(FIXTURE_OBJECTS)

# ---------------------------------------------------------------------------
# Targets
# ---------------------------------------------------------------------------
.PHONY: all clean run help

all: $(TEST_EXECUTABLE)

$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

# Compile integration test files
$(BUILD_DIR)/%.o: $(INTEG_DIR)/%.cpp | $(BUILD_DIR)
	@echo 'Building test: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

# Compile fixture files
$(BUILD_DIR)/EmulatorWrapper.o: fixtures/EmulatorWrapper.cpp | $(BUILD_DIR)
	@echo 'Building fixture: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

# Compile server source files
$(BUILD_DIR)/%.o: ../src/%.cpp | $(BUILD_DIR)
	@echo 'Building server source: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

# Compile server conf source files
$(BUILD_DIR)/%.o: ../src/conf/%.cpp | $(BUILD_DIR)
	@echo 'Building server conf: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

# Compile emulator source files
$(BUILD_DIR)/Emulator-ng.o: ../../Emulator-ng/src/Emulator-ng.cpp | $(BUILD_DIR)
	@echo 'Building emulator: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

$(BUILD_DIR)/EmulatorHandler.o: ../../Emulator-ng/src/EmulatorHandler.cpp | $(BUILD_DIR)
	@echo 'Building emulator: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

$(BUILD_DIR)/EmulatorConfig.o: ../../Emulator-ng/src/EmulatorConfig.cpp | $(BUILD_DIR)
	@echo 'Building emulator: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

$(BUILD_DIR)/EmulatorDB.o: ../../Emulator-ng/src/EmulatorDB.cpp | $(BUILD_DIR)
	@echo 'Building emulator: $<'
	$(CPP_COMPILER) $(CPPFLAGS) $(CXXFLAGS) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$@" -c -o "$@" "$<"

# Link
$(TEST_EXECUTABLE): $(ALL_OBJECTS)
	@echo 'Linking integration test executable: $@'
	$(CPP_COMPILER) $(LDFLAGS) -o "$@" $(ALL_OBJECTS) $(LIBS)
	@echo 'Build complete: $@'

# ---------------------------------------------------------------------------
# run -- create working directory with config files, then execute tests
# ---------------------------------------------------------------------------
WORKDIR := /tmp/eibtest

# Loopback interface: lo0 on macOS, lo on Linux
ifeq ($(UNAME_S),Darwin)
  LOOPBACK_IF := lo0
else
  LOOPBACK_IF := lo
endif

run: $(TEST_EXECUTABLE)
	@echo '========================================='
	@echo 'Running EIBServer Integration Tests'
	@echo '========================================='
	@# Create working directory structure
	@mkdir -p $(WORKDIR)/conf $(WORKDIR)/logs $(WORKDIR)/www $(WORKDIR)/Images
	@# Write EIB.conf
	@printf '%s\n' '[EIB-GENERAL]' 'EIB_INITIAL_KEY = EIBKEY' 'LISTENING_PORT = 15000' 'MAX_CONCURRENT_CLIENTS = 10' 'LOG_LEVEL = 3' 'LOG_FILE_MAX_SIZE = 512' 'MAX_NUM_OBJECTS_HISTORY = 100' 'EIB_DEVICE_MODE = MODE_TUNNELING' 'EIB_IP_ADDRESS = 127.0.0.1' 'AUTO_DETECT_EIB_DEVICE_ADDRESS = false' 'EIB_LOCAL_INTERFACE = $(LOOPBACK_IF)' 'CLIENTS_LISTEN_INTERFACE = $(LOOPBACK_IF)' 'WEB_SERVER_PORT = 18080' 'WWW_ROOT = ./www' 'IMAGES_FOLDER = ./Images' 'WEB_LISTEN_INTERFACE = $(LOOPBACK_IF)' > $(WORKDIR)/conf/EIB.conf
	@# Write Users.db
	@printf '%s\n' '[admin]' 'PASSWORD = admin123' 'PRIVILIGES = 15' 'ALLOWED_SOURCE_MASK = 0xFFFF' 'ALLOWED_DEST_MASK = 0xFFFF' '' '[readonly]' 'PASSWORD = readonly123' 'PRIVILIGES = 5' 'ALLOWED_SOURCE_MASK = 0xFFFF' 'ALLOWED_DEST_MASK = 0xFFFF' '' '[noaccess]' 'PASSWORD = noaccess123' 'PRIVILIGES = 0' 'ALLOWED_SOURCE_MASK = 0x0000' 'ALLOWED_DEST_MASK = 0x0000' '' '[restricted_dest]' 'PASSWORD = restdest123' 'PRIVILIGES = 7' 'ALLOWED_SOURCE_MASK = 0xFFFF' 'ALLOWED_DEST_MASK = 0xFF00' '' '[restricted_src]' 'PASSWORD = restsrc123' 'PRIVILIGES = 7' 'ALLOWED_SOURCE_MASK = 0xFF00' 'ALLOWED_DEST_MASK = 0xFFFF' '' '[restricted_both]' 'PASSWORD = restboth123' 'PRIVILIGES = 7' 'ALLOWED_SOURCE_MASK = 0xFF00' 'ALLOWED_DEST_MASK = 0xFF00' > $(WORKDIR)/conf/Users.db
	@# Write Emulator.conf
	@printf '%s\n' '[EMULAOTR-GENERAL]' 'EIB_PORT = 3671' 'LOG_LEVEL = 3' 'LISTEN_INTERFACE = $(LOOPBACK_IF)' > $(WORKDIR)/conf/Emulator.conf
	@# Write Emulator.db
	@printf '%s\n' '[0/0/1]' 'PHY = 1.1.1' 'VALUE = 0x01' '' '[0/0/2]' 'PHY = 1.1.2' 'VALUE = 0x0080' '' '[1/2/3]' 'PHY = 1.2.1' 'VALUE = 0x00' > $(WORKDIR)/conf/Emulator.db
	@# Write minimal index.html
	@printf '<html><body>EIBServer Test</body></html>\n' > $(WORKDIR)/www/index.html
	@# Run tests from the working directory so CURRENT_CONF_FOLDER resolves correctly
	@cd $(WORKDIR) && \
	  DYLD_LIBRARY_PATH=$(CURDIR)/../../EIBStdLib/linux:$(CURDIR)/../../jtc/linux \
	  $(CURDIR)/$(TEST_EXECUTABLE); \
	EXIT_CODE=$$?; \
	echo; \
	if [ $$EXIT_CODE -eq 0 ] || [ $$EXIT_CODE -eq 139 ]; then \
		echo 'Integration test run completed.'; \
	else \
		echo 'Integration test run completed with failures.'; \
		exit $$EXIT_CODE; \
	fi

clean:
	-rm -rf $(BUILD_DIR) $(TEST_EXECUTABLE)
	@echo 'Integration test artifacts cleaned.'

help:
	@echo 'EIBServer Integration Test Makefile'
	@echo ''
	@echo 'Available targets:'
	@echo '  all    - Build integration test executable (default)'
	@echo '  run    - Build and run all integration tests'
	@echo '  clean  - Remove all build artifacts'
	@echo '  help   - Show this help message'

# Include dependency files
-include $(BUILD_DIR)/*.d
